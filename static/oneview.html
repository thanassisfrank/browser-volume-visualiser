<!DOCTYPE html>
<html>
    <head>
        <title>Volume visualiser</title>
        <style>
            * {
                font-family:monospace;
            }
            body {
                padding: 0px;
                margin: 0px;
            }
            #c{
                position: absolute;
                margin: 0px;
                width: 100%;
                height: 100%;
                z-index: -1;
                /* background-color: blue; */
            }
            .view-container {
                margin: 0px;
                position: absolute;
                width: 100%;
                height: 100%;
                /* border: 1px solid blue; */
            }
            .view-frame {
                position: absolute;
                width: calc(100%);
                height: calc(100%);
                text-align: center;
                /* border: 1px solid red; */
            }
            .bottom-bar{
                position: absolute;
                bottom: 0px;
                padding: 5px;
                background: white;
                border: 1px solid black;
                z-index: 1;
            }
            .view-info {
                padding: 1px;
                margin: 0px;
                text-align: left
            }
            .view-dataset-name {
                font-weight: bold;
            }
            .view-close {
                color:crimson
            }
            #frame-info {
                position: absolute;
            }
            #frame-time {
                padding: 2px;
                margin: 2px;
            }
            #frame-time-graph {
                height: 50px;
                width: 100px;
            }
            #ray-march-opts-container {
                position: absolute;
                padding: 5px;
                right: 0px;
                background: white;
                border: 1px solid black;
                z-index: 1;
            }
            .clickable {
                text-decoration-line: underline;
                text-decoration-style: wavy;
                font-weight: bold;
            }
            .clickable:hover {
                cursor: pointer;
            }
            #create-view-btn {
                color:darkgreen;
            }
        </style>
    </head>
    <body>
        <!-- The main canvas onto which all views are drawn -->
        <canvas id="c"></canvas>

        <div id="frame-info">
            <canvas id="frame-time-graph"></canvas>
        </div>

        <div id="ray-march-opts-container">
            <input type="checkbox" class="ray-march-opt" name="showSurface"><label>Show surface</label><br>
            <input type="checkbox" class="ray-march-opt" name="showVolume"><label>Show volume</label><br>
            <input type="checkbox" class="ray-march-opt" name="phong"><label>Phong</label><br>
            <input type="checkbox" class="ray-march-opt" name="backStep"><label>Back step</label><br>
            <input type="checkbox" class="ray-march-opt" name="optimiseOffset"><label>Offset tuning</label><br>
            <input type="checkbox" class="ray-march-opt" name="randStart"><label>Random offset</label><br>
            <label>Performance</label><br>
            <input type="checkbox" class="ray-march-opt" name="cheapMove"><label>Cheap move</label><br>
            <input type="checkbox" class="ray-march-opt" name="sampleNearest"><label>Sample nearest</label><br>
            <label>Debug</label><br>
            <input type="checkbox" class="ray-march-opt" name="fixedCamera"><label>Fixed camera</label><br>
            <input type="checkbox" class="ray-march-opt" name="showRayDirs"><label>Ray direction</label><br>
            <input type="checkbox" class="ray-march-opt" name="showDeviceCoords"><label>Device coords</label><br>
            <input type="checkbox" class="ray-march-opt" name="showOffset"><label>Ray offset</label><br>
            <input type="checkbox" class="ray-march-opt" name="showRayLength"><label>Ray length</label><br>
            <input type="checkbox" class="ray-march-opt" name="showNormals"><label>Normals</label><br>
        </div>

        <div id="add-view-container" class="bottom-bar">
            <select id="data-select"></select><br>
            <input type="checkbox" class="dataset-opt" name="createUnstructured"><label>Make unstruct</label><br>
            <label id="create-view-btn" class="clickable">Create new</label>
        </div>

        <!-- 
        The container into which views will be pushed
        In this page, this covers the screen 
        -->
        <div id="view-container-container"></div>

        <!-- The prototypical view-container that will be cloned for each view-->
        <div id="view-container-proto" class="view-container" style="display: none">
            <div class="view-frame">
                <div class="bottom-bar view-bottom-bar">
                    <p class="view-dataset-name view-info"></p>
                    <p class="view-dataset-size view-info"></p>
                    <input type="range" class="view-threshold">
                    <p class="view-info">Threshold: <span class="view-threshold-value"></span></p>
                    <label class="view-close view-info clickable">Close</label>
                </div>
            </div>
        </div>

        <script type="module">
            import {get, getClass, isVisible, show, hide, removeAllChildren, setupCanvasDims, repositionCanvas, parseXML, IntervalTree, OldIntervalTree, timer} from "./core/utils.js";

            import { dataManager } from "./core/data/data.js";
            import { createRenderEngine } from "./core/renderEngine/renderEngine.js";
            import { viewManager } from "./view.js";
            import { Camera, SceneObjectRenderModes } from "./core/renderEngine/sceneObjects.js";
            import { FrameTimeGraph } from "./frameTimeGraph.js";

            var setUpRayMarchOptions = (rayMarcher) => {
                for (let elem of getClass("ray-march-opt")) {
                    elem.checked = rayMarcher.getPassFlag(elem.name);
                    elem.addEventListener("mousedown", (e) => {
                        e.stopPropagation();
                        return false;
                    })
                    elem.addEventListener("click", (e) => {
                        rayMarcher.setPassFlag(elem.name, elem.checked);
                    })
                }
            }

            var populateDataOptions = (dataManager) => {
                var dataOptions = get("data-select");
                for (let id in dataManager.configSet) {
                    var elem = document.createElement("OPTION");
                    elem.value = id;                
                    elem.innerText = dataManager.configSet[id].name;
                    dataOptions.appendChild(elem);
                }
            }
            
            // define the main function
            async function main() {
                var canvas = get("c");
                
                var frameTimeGraph = new FrameTimeGraph(get("frame-time-graph"));

                // create a new rendering engine
                var renderEngine = await createRenderEngine(canvas);
                await renderEngine.setup();
                await renderEngine.rayMarcher.setupEngine();
                // set up options elements
                setUpRayMarchOptions(renderEngine.rayMarcher);


                const serverDatasets = await fetch("/data/datasets.json")
                    .then((res) => res.json());

                const allDatasets = {
                    ...serverDatasets,
                    test: {
                        name: "Small Test",
                        size: {
                            x: 4,
                            y: 4,
                            z: 4
                        },
                        cellSize: {
                            x: 1,
                            y: 1,
                            z: 1
                        },
                        f: (x, y, z) => Math.sqrt(Math.pow(x, 2) + Math.pow(y, 2) + Math.pow(z, 2))
                    }
                }
                
                // setup data manager with these
                dataManager.setConfigSet(allDatasets);
                var camera = new Camera();
                populateDataOptions(dataManager);

                // set the max views
                viewManager.maxViews = 1;

                get("create-view-btn").addEventListener("click", async (e) => {
                    var d = get("data-select");

                    const selectedDataElem = d.options[d.selectedIndex];

                    var newData = await dataManager.getDataObj(selectedDataElem.value);

                    for (let opt of getClass("dataset-opt")) {
                        if (!opt.checked) continue;
                        switch (opt.name) {
                            case "createUnstructured":
                                dataManager.convertStructuredToUnstructured(newData);
                                break;
                        }
                    }

                    var newView = await viewManager.createView({
                        camera: camera,
                        data: newData,
                        renderMode: SceneObjectRenderModes.DATA_RAY_VOLUME
                    }, renderEngine);

                    // hide the window
                    hide(get("add-view-container"))                     
                });


                // shortcuts
                document.body.addEventListener("keydown", function(e) {
                    switch (e.key) {
                        case " ":
                            // print the camera position and threshold val
                            camera.printVals();
                            console.log("threshold", newView.threshold);
                            
                            break;
                        case "r":
                            // reset camera to initial position
                            camera.moveToStart();
                            break;
                        case "h":
                            // toggle visiblity of overlay elements
                            for (let elem of [...getClass("view-bottom-bar"), get("ray-march-opts-container"), get("frame-info")]) {
                                if (isVisible(elem)) {
                                    hide(elem);
                                } else {
                                    show(elem);
                                }
                            }
                            break;
                        case "Alt":
                            e.preventDefault();
                            break;
                    }
                });

                var resize = () => {
                    var canvasDims = setupCanvasDims(canvas);
                    // change camera aspect ratio
                    camera.setAspectRatio(canvasDims[0]/canvasDims[1]);
                    renderEngine.resizeRenderingContext();
                }
                resize();

                window.addEventListener("resize", resize);

                var lastFrameStart = performance.now();
                var renderLoop = async (timeGap) => {
                    var thisFrameStart = performance.now();
                    const dt = thisFrameStart - lastFrameStart;
                    lastFrameStart = thisFrameStart;

                    
                    // update the objects
                    frameTimeGraph.update(dt);
                    // does stuff like propagating threshold value, fetching required data
                    viewManager.update(dt, renderEngine);
                    
                    
                    // render the scenes
                    // includes doing marching cubes/ray marching if required by object
                    var viewList = Object.values(viewManager.views);
                    if (viewList.length == 0) {
                        renderEngine.clearScreen();
                    } else {
                        for (let view of Object.values(viewManager.views)) {
                            await renderEngine.renderView(view);
                        }
                    }
                    
                    // next frame
                    requestAnimationFrame(renderLoop);
                };
                renderLoop();
            }
            // window.addEventListener("load", main);
            document.body.onload = main;
        </script>
    </body>
</html>